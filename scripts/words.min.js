// TODO: Loading indicator
// TODO: Background colour of box in autosuggest should be the same as the line on the graph
// TODO: Axis labels
var words={init:function(a,b,c){function d(){var a=$("#words-type-select").val();switch(a){case"top-five":$("#specific-words").fadeOut("fast");words.draw(_.keys(words.topFive));break;case"specific":$("#specific-words").fadeIn("fast");break;default:$("#specific-words").fadeOut("fast");words.draw(a)}$(words.origin).removeClass()}this.origin=a;this.overallData=b;this.allWords=_.extend(this.overallData.nz,this.overallData.fra),this.minuteData=_.pluck(c,"words");this.topStopwords=["france","french","new","zealand","kiwi","blacks","bleus"];this.topFive=this.getTop(this.overallData,5),this.refineMinuteData();$("#words-type-select").append('<option value="">-----------</option>');_.each(this.allWords,function(a,b){var c=String.capitalize(b);$("#words-type-select").append('<option value="'+b+'">'+c+"</option")});$("#words-type-select").change(function(){var a=$(this).val(),b=250;if(a){if(a!=="specific"){$(words.origin).addClass("loading");b=0}setTimeout(d,b)}return!1});$("#specific-words").submit(function(){if($(".as-values").val().length>0){var a=$(".as-values").val().split(",");$(words.origin).addClass("loading");words.draw(a);$(words.origin).removeClass("loading")}return!1});$("#specific-words-input").autoSuggest(this.constructAutoSuggestData(),{selectedItemProp:"name",searchObjProps:"name",minChars:2,startText:"Pick an available word"})},constructAutoSuggestData:function(){var a=[];_.each(this.allWords,function(b,c){var d={value:c,name:c};a.push(d)});return a},refineMinuteData:function(){for(var a=0,b=this.minuteData.length;a<b;a++)for(var c in this.minuteData[a])_.each(this.minuteData[a][c],function(b,d){_.has(words.overallData[c],d)||delete words.minuteData[a][c][d]})},getTop:function(a,b,c,d){var e;d?e=c?a[d][c]:this.concatObj(a[d].fra,a[d].nz):e=c?a[c]:this.concatObj(a.fra,a.nz);var f=function(a,b){return!_.contains(words.topStopwords,b)},g=_.filter(e,f).sort(function(a,b){return a-b}).reverse(),h=_.first(g,b),j={};for(i=0;i<h.length;i++)_.each(e,function(a,c){a===h[i]&&!_.has(j,c)&&_.size(j)<b&&(j[c]=a)});return j},concatObj:function(){var a={};for(i=0;i<arguments.length;i++)for(var b in arguments[i])_.has(a,b)?a[b]+=arguments[i][b]:a[b]=arguments[i][b];return a},draw:function(a,b,c){this.graph.draw(a)},getWordData:function(a){var b=[];for(var c=0,d=this.minuteData.length;c<d;c++){var e=0;for(var f in this.minuteData[c])this.minuteData[c][f][a]&&(e+=this.minuteData[c][f][a]);b.push(e)}return b},drawEvent:function(a,b,c){if(a in rwclib.events){var d=rwclib.events[a],e="<h4>Minute "+a+"</h4><p>"+d.type+": ";switch(d.type){case"Substitution":if(typeof d.on=="object"){var f=d.on.join(" and "),g=d.off.join(" and ");e+=f+" came on for "+g+", respectively"}else e+=d.on+" came on for "+d.off;break;case"Penalty":case"Conversion":e+="Kicked by "+d.scorer;break;case"Try":e+="Scored by "+d.scorer}e+="</p>";$(".events",this.origin).length==0&&$(this.origin).append('<div class="events" />');$('<span class="event"></span>').appendTo(".events",this.origin).attr("data-event-type",d.type.toLowerCase()).attr("data-minute",a).css({width:c,position:"absolute",top:0,left:b}).tipTip({content:e,defaultPosition:"top",delay:350})}}};words.graph={draw:function(a){var b=[],c=[],d=[];if(typeof a=="object"){for(var e=0;e<a.length;e++)if(a[e].length>0){d.push(a[e]);b.push(words.getWordData(a[e]))}}else{d.push(a);b.push(words.getWordData(a))}for(e=0;e<b[0].length;e++){var f={minute:e+1};for(j=0;j<b.length;j++)f[d[j]]=b[j][e];c.push(f)}Morris.Line({element:$(words.origin).attr("id"),lineColors:["#1F78B4","#A65628","#33A02C","#E31A1c","#FF7F00","#F781BF"],data:c.reverse(),xkey:"minute",ykeys:d,labels:_.map(d,function(a){return String.capitalize(a)}),numLines:10,parseTime:!1}).redraw()}};