// TODO: BETTER LAYOUT!!!
var players={playerStats:{},extractedData:{},imageBase:"images/players/",init:function(a,b){this.origin=a;this.data=b;this.constructPlayerInfo()},constructPlayerInfo:function(){var a={};for(var b in this.data){var c=this.data[b].players;for(var d in c){var e=c[d];if(typeof e=="object"){typeof a[d]!="object"&&(a[d]={neg:0,pos:0,tweets:0,team:e.team,name:d});a[d].neg+=e.neg;a[d].pos+=e.pos;a[d].tweets+=e.tweets}}}a=_.filter(a,function(a){return a.tweets>100?!0:!1});this.playerStats=_.sortBy(a,function(a){return a.tweets>30?a.pos/(a.tweets/100):!1})},getPlayers:function(a){var b=[];if(!a)b=this.playerStats;else if(a&&a>0){var c=this.playerStats.length-1,d=c-a;while(c>d){b.push(this.playerStats[c]);c--}}else if(a&&a<0){var c=0;while(c<Math.abs(a)){b.push(this.playerStats[c]);c++}}return b},draw:function(){var a=this.getPlayers();this.chart.maxTweets=_.max(a,function(a){return a.tweets}).tweets;this.chart.motm=_.max(a,function(a){return a.pos/(a.tweets/100)}).name;this.chart.worst=_.min(a,function(a){return a.pos/(a.tweets/100)}).name;for(var b=0;b<a.length;b++)this.chart.draw(a[b]);$(this.origin).masonry({itemSelector:".chart"})},getRealPlayerName:function(a){return String.capitalize(a.replace(/_/g," "))},drawPieChart:function(a,b,c,d,e){var f=a.getContext("2d");a.width=d;a.height=e;var g=radius=a.width/2;this.drawPieChartArc(f,g,radius,Math.PI*2,"rgb(215, 25, 28)");this.drawPieChartArc(f,g,radius,Math.PI*2*(c/100),"#1A9641");var h=f.createRadialGradient(g,g,0,g,g,radius);h.addColorStop(0,"rgba(255, 255, 255, 0.2)");h.addColorStop(1,"rgba(255, 255, 255, 0)");this.drawPieChartArc(f,g,radius,Math.PI*2,h);this.drawPlayerImage(f,g,g,35,b)},drawPieChartArc:function(a,b,c,d,e){a.beginPath();a.moveTo(b,b);a.arc(b,b,c,0,d,!1);a.lineTo(b,b);a.closePath();a.fillStyle=e;a.fill()},drawPlayerImage:function(a,b,c,d,e,f){var g=new Image;g.onload=function(){a.save();a.beginPath();a.moveTo(b,c);a.arc(b,c,d,0,Math.PI*2,!0);a.clip();a.drawImage(g,b-d,c-d,d*2,d*2);if(f){a.lineWidth=1;a.strokeStyle="rgba(0, 0, 0, 0.25)";a.stroke()}a.restore()};g.src=this.imageBase+e+".jpg"}};players.chart={maxTweets:0,maxChartWidth:350,minChartWidth:150,colours:{positive:[139,70,35],negative:[359,78,47]},animate:{ms:150,easing:"ease-in-out"},rad:Math.PI/180,draw:function(a){if($("#"+a.name).length==0){var b=players.origin,c=this.maxTweets/100,d=a.tweets/c/100,e=a.pos/(a.tweets/100),f=["chart"],g={positive:e,negative:100-e};a.name==this.motm&&f.push("motm");a.name==this.worst&&f.push("worst");$('<div class="'+f.join(" ")+'" id="'+a.name+'" />').appendTo(b);this.width=this.height=Math.round(this.maxChartWidth*d)+this.minChartWidth,this.center=this.width/2;this.radius=this.center*.9;this.startAngle=0;this.p=Raphael(a.name,this.width,this.height);for(var h in g)this.drawSegment(h,g[h]);var i=imgHeight=this.radius*.5,j=this.center-i/2;this.p.image(players.imageBase+a.name+".png",j,j,i,imgHeight);var k="<h4>"+players.getRealPlayerName(a.name)+"</h4>";k+="<p>"+a.tweets+" tweets</p>";k+="<p>"+a.pos+" positive</p>";k+="<p>"+a.neg+" negative</p>";$("#"+a.name).tipTip({content:k,defaultPosition:"top",delay:150})}},drawSegment:function(a,b){var c=this,d=b*3.6,e=this.colours[a],f="hsl("+e[0]+","+e[1]+","+e[2]+")",g="hsl("+e[0]+","+e[1]+","+(e[2]+10)+")",h=this.drawArc(this.center,this.center,this.radius,this.startAngle,this.startAngle+d,{fill:"90-"+f+"-"+g,stroke:""}),i=this.startAngle+d/2;x=this.center+this.radius/1.7*Math.cos(-i*this.rad),y=this.center+this.radius/1.7*Math.sin(-i*this.rad),textStyles={"font-weight":"bold",fill:"rgba(255, 255, 255, 0.7)","font-size":this.calculateFontSize(this.width)},text=this.p.text(x,y,Math.round(b)+"%").attr(textStyles);h.hover(function(){var a=this.attrs.path[0][1];h.stop().animate({transform:"s1.05,1.05,"+a+","+a},c.animate.ms,c.animate.easing)},function(){h.stop().animate({transform:""},c.animate.ms,c.animate.easing)});this.startAngle+=d},drawArc:function(a,b,c,d,e,f){var g=a+c*Math.cos(-d*this.rad),h=a+c*Math.cos(-e*this.rad),i=b+c*Math.sin(-d*this.rad),j=b+c*Math.sin(-e*this.rad);return this.p.path(["M",a,b,"L",g,i,"A",c,c,0,+(e-d>180),0,h,j,"z"]).attr(f)},calculateFontSize:function(a){return a*.09+"px"}};