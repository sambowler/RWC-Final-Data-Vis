// FIXME: Bar graphs on resize
var sentiment={drawn:!1,keyContainer:$("#sentiment-key"),init:function(a,b){this.origin=a;b.shift();this.data=b;this.elCount=this.data.length;$(a).append('<div id="canvas-container"><canvas>Your browser doesn\'t support canvas.</canvas></div>');this.canvas=$(a).find("canvas")[0];this.ctx=this.canvas.getContext("2d");this.calculateMaxTweetCount();this.minuteInfo.draw();$("#graph-type").change(function(){sentiment.changeType($(this).val())})},calculateMaxTweetCount:function(){var a=0;for(var b=0;b<this.elCount;b++){var c=this.data[b];a=c.tweet_count>a?c.tweet_count:a}this.maxTweetCount=a},draw:function(a,b,c){this.width=a;this.height=b;var d=this.canvas,e=this.ctx;d.height=this.height;d.width=this.width;this.minuteWidth=Math.floor(this.canvas.width/this.elCount);this.canvasMiddle=this.canvas.height/2;this.drawGraphLines();this.drawMiddleSection(25);this.extractData();this.updateType(c);this.drawYAxis(25);this.drawn=!0},changeType:function(a){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.drawGraphLines();this.updateType(a)},updateType:function(a){this.currentGraphType=a;$(this.origin).removeClass().addClass(a);switch(a){case"stacked":this.stackedGraph.draw(this.ctx,this.extractedData);break;case"heat":this.heatGraph.draw(this.ctx,this.extractedData);break;default:this.stackedGraph.draw(this.ctx,this.extractedData)}},extractData:function(){var a=this.topBottom,b=this.maxTweetCount/a;this.extractedData={nz:[],fra:[]};for(var c=0;c<this.elCount;c++){var d=this.data[c],e={height:Math.round(d.team_1_tweets/b),positivity:d.sentiment.team_1},f={height:Math.round(d.team_2_tweets/b),positivity:d.sentiment.team_2};this.extractedData.nz.push(e);this.extractedData.fra.push(f)}},drawGraphLines:function(){var a=this.ctx;a.lineWidth=1;a.strokeStyle="rgba(0, 0, 0, 0.1)";a.beginPath();var b=this.elCount+1;for(i=0;i<b;i++){var c=i*this.minuteWidth+.5;a.moveTo(c,0);a.lineTo(c,this.canvas.height)}this.graphWidth=(b-1)*this.minuteWidth+.5;a.closePath();a.stroke()},drawMiddleSection:function(a){var b=this.canvasMiddle-a/2;this.drawLabels(b,a);this.teamGraphHeight=this.topBottom=this.canvasMiddle-a/2;this.bottomTop=this.canvasMiddle+a/2;$("#team-info-container div").height(this.topBottom).css("lineHeight",this.topBottom+"px")},drawLabels:function(a,b){var c=$('<div class="x-axis" />').appendTo("#canvas-container");$(c).css({position:"absolute",left:0,top:0,height:"100%",width:this.canvas.width,lineHeight:this.canvas.height+"px"});for(i=0;i<this.elCount;i++){var d=i+1,e=$('<span data-minute="'+d+'" style="width: '+this.minuteWidth+'px">'+d+"</span>").appendTo(c).click(function(){sentiment.handleMinuteClick(this)});if(d in rwclib.events){var f=rwclib.events[d],g="<h4>Minute "+d+"</h4><p>"+f.type+": ";switch(f.type){case"Substitution":if(typeof f.on=="object"){var h=f.on.join(" and "),j=f.off.join(" and ");g+=h+" came on for "+j+", respectively"}else g+=f.on+" came on for "+f.off;break;case"Penalty":case"Conversion":g+="Kicked by "+f.scorer;break;case"Try":g+="Scored by "+f.scorer}g+="</p>";$(e).attr("data-event-type",f.type.toLowerCase()).tipTip({content:g,defaultPosition:"top",delay:350})}}this.labelHeight=b},drawLine:function(a,b,c,d,e,f){var g=this.ctx;b+=.5;c+=.5;d+=.5;e+=.5;g.lineWidth=a;g.strokeStyle=f;g.beginPath();g.moveTo(b,c);g.lineTo(d,e);g.closePath();g.stroke()},drawYAxis:function(a){if(!this.origin.prev().hasClass("y-axis")){var b=250,c=Math.floor(this.maxTweetCount/b)+1,d=$('<div class="y-axis" />').insertBefore(this.origin);$(d).height(this.height);for(i=0;i<c;i++){var e=i*(this.teamGraphHeight/c);$(d).append('<span style="top: '+e+'px">'+(c-(i+1))*b+"</span>")}$(d).append('<span class="middle" style="height: '+a+'px"></span>');for(i=0;i<c;i++){var e=i*(this.teamGraphHeight/c)+this.teamGraphHeight-4;$(d).append('<span style="top: '+e+'px">'+i*b+"</span>")}}},handleMinuteClick:function(a){var b=$(a).attr("data-minute");$(this.origin).find("[data-minute]").removeClass("active").end().find(".x-axis").addClass("active-minute");$(a).addClass("active");var c=$(a).offset().left-$(this.origin).offset().left+$("#canvas-container").scrollLeft()+this.minuteWidth;this.minuteInfo.update(c,b)},attachScrollOnClick:function(){this.minuteInfo.scrollOnClick=!0}};sentiment.minuteInfo={scrollOnClick:!1,draw:function(){var a='<div class="sentiment"><canvas class="pie-chart" /></div><ol class="word-graph" />';this.origin=$("#minute-info");this.els={nz:$(this.origin).find(".nz").append(a),middle:$(this.origin).find(".middle"),fra:$(this.origin).find(".fra").append(a)}},update:function(a,b){var c=""+(b-1),d=sentiment.data[c];if(this.origin.not(":visible")){this.origin.prev().width("56%");this.origin.width("40%").show()}$(this.origin).find("h3").text("Minute "+b);for(var e in this.els){var f=this.els[e],g=150,h=$(f).width()-g-40;if(e!="middle"){var i=$(f).hasClass("nz")?"team_1":"team_2",j=d.sentiment[i],k=d[i+"_tweets"],l=$(f).find(".sentiment"),m=$(f).find(".word-graph"),n=words.getTop(words.minuteData,5,$(f).attr("class"),c);$(f).height(sentiment.teamGraphHeight);this.updateSentimentEl(l,j,g,g);this.updateTopWords(m,k,n,h)}else $(f).html('<span style="width: '+g+'px;">Sentiment</span><span style="width: '+h+'px;">Most Used Words</span><div id="minute-info-close"></div>')}$("#minute-info-close").click(function(){sentiment.origin.width("96%").find("[data-minute]").removeClass("active");$("#minute-info").hide()});this.scrollOnClick&&$(window).scrollTop($(this.origin).offset().top)},drawPieChart:function(a,b,c,d){var e=a.getContext("2d");a.width=c;a.height=d;e.clearRect(0,0,a.width,a.height);var f=radius=a.width/2,g=Math.PI*2,b=g*(b/100),h=e.createRadialGradient(f,f,0,f,f,radius);this.drawPieChartArc(e,f,radius,g,"rgb(215, 25, 28)");this.drawPieChartArc(e,f,radius,b,"#1A9641");h.addColorStop(0,"rgba(255, 255, 255, 0.15)");h.addColorStop(1,"rgba(255, 255, 255, 0)");this.drawPieChartArc(e,f,radius,g,h)},drawPieChartArc:function(a,b,c,d,e){a.beginPath();a.moveTo(b,b);a.arc(b,b,c,0,d,!1);a.lineTo(b,b);a.closePath();a.fillStyle=e;a.fill()},updateSentimentEl:function(a,b,c,d){$(a).width(c);this.drawPieChart($(a).find("canvas")[0],b,c,d);$(a).find("p").length==0&&$(a).append('<p class="pos" /><p class="neg" />');$(a).find(".pos").text(b+"% positive");$(a).find(".neg").text(100-b+"% negative")},updateTopWords:function(a,b,c,d){var e=$(a).empty(),f=d*.7,g=b/100;e.width(d).append("<li>Total ("+b+') <span style="width: '+f+'px;"></span></li>');for(var h in c)e.append("<li>"+h+" ("+c[h]+') <span style="width: '+Math.round(c[h]/g)+'px;"></span></li>')}};sentiment.heatGraph={colours:{"31-40":"rgb(215, 48, 39)","41-50":"rgb(252, 141, 89)","51-60":"rgb(254, 224, 139)","61-70":"rgb(255, 255, 191)","71-80":"rgb(217, 239, 139)","81-90":"rgb(145, 207, 96)","91-100":"rgb(26, 152, 80)"},lightColours:["41-50","51-60","61-70","71-80","81-90"],draw:function(a,b){this.drawKey();for(var c in b)for(var d=0,e=b[c].length;d<e;d++){var f=b[c][d],g=d*sentiment.minuteWidth,h;c=="nz"?h=sentiment.topBottom-f.height:c=="fra"&&(h=sentiment.bottomTop);g+=.5;h+=.5;var i=this.getRange(f.positivity);a.fillStyle=this.colours[i];a.fillRect(g,h,sentiment.minuteWidth,f.height);f.range=i}},getRange:function(a){var b="";for(var c in this.colours){var d=c.split("-");a>=+d[0]&&a<=+d[1]&&(b=c)}return b},drawKey:function(){sentiment.keyContainer.find("span").remove();for(var a in this.colours){var b="#FFF";this.lightColours.indexOf(a)!=-1&&(b="#000");sentiment.keyContainer.append('<span style="background-color: '+this.colours[a]+"; color: "+b+'">'+a+"%</span>")}}};sentiment.stackedGraph={colours:{positive:"rgb(26, 152, 80)",negative:"rgb(215, 48, 39)"},draw:function(a,b){this.drawKey();for(var c in b)for(var d=0,e=b[c].length;d<e;d++){var f=b[c][d],g=d*sentiment.minuteWidth,h,i=this.calculateHeights(f.height,f.positivity);if(c=="nz"){h=sentiment.topBottom-f.height;negativeY=h}else if(c=="fra"){h=sentiment.bottomTop;negativeY=h+(f.height-i)}g+=.5;h+=.5;negativeY+=.5;a.fillStyle=this.colours.positive;a.fillRect(g,h,sentiment.minuteWidth,f.height);a.fillStyle=this.colours.negative;a.fillRect(g,negativeY,sentiment.minuteWidth,i)}},calculateHeights:function(a,b){var c=a/100,d=100-b;return Math.round(d*c)},drawKey:function(){sentiment.keyContainer.find("span").remove();for(var a in this.colours)sentiment.keyContainer.append('<span style="background-color: '+this.colours[a]+'; color: #FFF">'+a+"</span>")}};